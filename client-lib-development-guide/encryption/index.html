<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Ably API Documentation - Encryption</title>
    <link rel="shortcut icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/vendor/prettify/prettify.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/stylesheet.css" media="screen">

    <script src="/vendor/javascripts/jquery-1-8-3-min.js" type="text/javascript"></script>
    <script src="/vendor/javascripts/jquery-cookie-1-3-1.js" type="text/javascript"></script>
    <script src="/vendor/javascripts/base64.js" type="text/javascript"></script>

    <script src="/vendor/prettify/prettify-lib.js" type="text/javascript"></script>

    <script src="//cdn.ably.io/lib/ably.min.js" type="text/javascript"></script>

    <script src="/javascripts/application.js" type="text/javascript"></script>
    <script src="/javascripts/lang-manager.js" type="text/javascript"></script>

    <!-- you don't need to keep this, but it's cool for stats! -->
    <meta name="generator" content="nanoc 3.7.5">
  </head>
  <body>
    <div class="canonical-notice">
      <img src="/images/icon-alert.png">
      <span class="canonical-notice-text">
        You are viewing our bleeding edge unstable documentation. We recommend you use our <a href="https://www.ably.io/documentation">stable documentation Â»</a>
      </span>
      <img src="/images/icon-alert.png">
    </div>
    <div class="fork-banner"><a href="https://github.com/ably/docs"><img src="/images/forkme.png" alt="Fork me on GitHub"></a></div>

  <div id="documentation">
    
      <nav class="jump-to-nav">
        <div class="form">
          <select id="jump-to-nav">
            <option>Jump to ...</option>
            <optgroup label='Help with'>
<option id="anchor-objectives-and-scope">Objectives and Scope</option>
<option id="anchor-encrypted-message-format">Encrypted message format</option>
<option id="anchor-examples">Examples</option>
</optgroup>
          </select>
        </div>
      </nav>
    
    <header>
      
        <div class="breadcrumb"><a href="/client-lib-development-guide/">Client Library Development Guide</a><span class="separator">/</span></div>
      
      
        <h1 id="title">Encryption</h1>
      
    </header>
    <article>
      <p>Ably client libraries support encryption of message content, making it easier to build apps that encrypt content fully end-to-end.</p>
<h2 id="objectives-and-scope">Objectives and Scope</h2>
<p>The libraries support encryption purely as a convenience; the libraries ensure interoperability between environments by having compatible implementations of encryption algorithms and by making common choices on format, mode, padding etc. However, Ably intentionally does not manage the distribution of keys between clients, and end-to-end encryption is enabled without exposing keys to the Ably service at all. This has the advantage that Ably demonstrably has no access to the unencrypted contents of your messages, but also means that each app is responsible for enabling the distribution of keys to clients independently of Ably.</p>
<p>The client library support for encryption supports symmetric encryption only, and requires each participating client to each specify the correct secret key when creating a <code>Channel</code> instance. Clients that do not specify a key will be delivered the still-encrypted message payloads that they may then still wish to decrypt offline.</p>
<p>The client libraries are designed to be extensible, but initially only support the AES algorithm (with a default key length of 128 bits) and CBC mode. These defaults are intended to ensure that encryption support can be provided in all target environments and platforms.</p>
<p>Encryption is supported for both REST and Realtime publish operations and presence data payloads. Decryption is supported in Realtime message subscriptions amd presence events and in REST and Realtime history operations.</p>
<p>The key in use at any given time is known by the client library, but the Ably service has no visibility of the key; it knows only that a given message payload was encrypted. When accessing messages via the history API, it is the caller&#8217;s responsibility to ensure that the correct key is used for the requested interval.</p>
<p>Only message data payloads are encrypted, all other message data and metadata is not encrypted; for example the <code>clientId</code> and event <code>name</code>. This means that messages with a specific event name can still be routed by the library to the correct handler even if the recipient does not have the key; the encrypted payload data is delivered instead. Furthermore, the message encoding attribute is simply regarded as metadata just like other message metadata.</p>
<p>Encryption options (algorithm, key, etc) are specified on a per-channel basis; it is expected that apps will wish to have both unencrypted and encrypted channels on a single connection.</p>
<h2 id="encrypted-message-format">Encrypted message format</h2>
<h3>Message representation</h3>
<p>All Ably messages carry their payload in a <code>data</code> member, with various supported data types. A given encrypted message can be exchanged using either the binary or JSON protocol and encryption and decryption are interoperable between the representations.</p>
<p>In the case of the JSON encoding, the <code>data</code> member either contains the data value directly (either a String, JSON Object or JSON Array) or contains an encoded string value, with the encoding specified in the <code>encoding</code> property of the message. For unencrypted messages, the type is implicit, or is implicitly a binary buffer when an <code>encoding</code> is present.</p>
<p>In the case of a JSON encoded encrypted message the <code>data</code> member always carries the encrypted message payload as a base64-encoded string and the <code>encoding</code> member contains the string <code>cipher+aes-128-cbc/base64</code>.</p>
<p>Therefore in the JSON encoding, an encrypted message is represented as follows:</p>
<pre lang="json"><code lang="json">{
  "id": "&lt;unique message ID string&gt;",
  "name": "&lt;name&gt;",
  "timestamp": &lt;timestamp&gt;,
  "data": "&lt;string containing base64-encoded representation of encrypted data&gt;",
  "encoding": "cipher+aes-128-cbc/base64"
}</code></pre>
<p></pre></p>
<h3>Plaintext</h3>
<p>Each possible data value type is canonically converted to a byte array before being encrypted, as follows:</p>
<dl>
	<dt><code>STRING</code></dt>
	<dd>the utf8-encoding of the string, without any trailing null byte</dd>
	<dt><code>BUFFER</code></dt>
	<dd>the unmodified buffer contents</dd>
	<dt><code>JSONOBJECT</code></dt>
	<dd>the utf8-encoding of the JSON-stringified value of the object</dd>
	<dt><code>JSONARRAY</code></dt>
	<dd>the utf8-encoding of the JSON-stringified value of the array</dd>
</dl>
<h3>Conversion to ciphertext</h3>
<p>Conversion from plaintext to ciphertext requires the following steps:</p>
<ul>
	<li>Obtain an initialisation vector (IV). This can be obtained from a local secure random source.</li>
	<li>Pad the plaintext. The plaintext is padded to be a multiple of 16 bytes (the AES block length) using PKCS#7 (<a href="http://tools.ietf.org/html/rfc5652#section-6.3">RFC 5652</a>).</li>
	<li>Encrypt the plaintext. This is performed using AES-CBC using the IV and padded plaintext.</li>
	<li>Construct the ciphertext message payload. This is the concatenation of the 16-byte IV followed by the ciphertext bytes.</li>
</ul>
<h2 id="examples">Examples</h2>
<p>All of the client libraries have identical encrypted message payload tests to ensure client libraries across all platforms encode and decode messages in binary compatible formats.  See the encoding tests for</p>
<ul>
	<li>Ably Javascript library: <a href="https://github.com/ably/ably-js/blob/master/spec/realtime/assets/crypto-data-128.json">AES 128 CBC fixture data</a>, <a href="https://github.com/ably/ably-js/blob/master/spec/realtime/assets/crypto-data-256.json">AES 256 CBC fixture data</a> and <a href="https://github.com/ably/ably-js/blob/master/spec/realtime/crypto.test.js">Crypto tests</a></li>
	<li>Ably Java library: <a href="https://github.com/ably/ably-java/blob/master/test/io/ably/test/assets/crypto-data-128.json">AES 128 CBC fixture data</a>, <a href="https://github.com/ably/ably-java/blob/master/test/io/ably/test/assets/crypto-data-256.json">AES 256 CBC fixture data</a> and <a href="https://github.com/ably/ably-java/blob/master/test/io/ably/test/realtime/RealtimeCryptoMessage.java">Crypto tests</a></li>
	<li>Ably Ruby library: <a href="https://github.com/ably/ably-ruby/blob/master/spec/resources/crypto-data-128.json">AES 128 CBC fixture data</a>, <a href="https://github.com/ably/ably-ruby/blob/master/spec/resources/crypto-data-256.json">AES 256 CBC fixture data</a> and <a href="https://github.com/ably/ably-ruby/blob/master/spec/acceptance/rest/message_spec.rb#L99-L107">Crypto tests</a></li>
</ul>
    </article>
    <hr class="back">
    <a href="#documentation">Back to top</a>
  </div>
  <div id="sidebar">
  <a href="/" title="API Documentation Home"><img src="/images/ably-logo.png" class="ably-logo" title="API Documentation Home"></a>
  <ul>
<li class=''><a href='/quick-start-guide/'>Quickstart Guide</a></li>
<li class=''><a href='/how-ably-works/'>How Ably works</a></li>
</ul>
  <h2><a href="/realtime/">Realtime client lib</a></h2>
<ul>
<li class=''><a href='/realtime/usage/'>Using the Realtime library</a></li>
<li class=''><a href='/realtime/connection/'>Connection</a></li>
<li class=''><a href='/realtime/channels-messages/'>Channels and Messages</a></li>
<li class=''><a href='/realtime/presence/'>Presence</a></li>
<li class=''><a href='/realtime/authentication/'>Authentication</a></li>
<li class=''><a href='/realtime/history/'>History</a></li>
<li class=''><a href='/realtime/encryption/'>Encryption</a></li>
<li class=''><a href='/realtime/statistics/'>Statistics</a></li>
<li class=''><a href='/realtime/types/'>Types</a></li>
</ul>
  <h2><a href="/rest/">REST client lib</a></h2>
<ul>
<li class=''><a href='/rest/usage/'>Using the REST library</a></li>
<li class=''><a href='/rest/channels-messages/'>Channels and Messages</a></li>
<li class=''><a href='/rest/presence/'>Presence</a></li>
<li class=''><a href='/rest/authentication/'>Authentication</a></li>
<li class=''><a href='/rest/history/'>History</a></li>
<li class=''><a href='/rest/encryption/'>Encryption</a></li>
<li class=''><a href='/rest/statistics/'>Statistics</a></li>
<li class=''><a href='/rest/types/'>Types</a></li>
</ul>
  <h2><a href="/rest-api/">REST API</a></h2>
<ul>
</ul>
  <h2>General</h2>
<ul>
<li class=''><a href='/general/authentication/'>Authentication</a></li>
<li class=''><a href='/general/channel-rules-namespaces/'>Channel Rules and Namespaces</a></li>
<li class=''><a href='/general/push-notifications/'>Mobile push notifications</a></li>
<li class=''><a href='/general/webhooks/'>Receiving WebHooks</a></li>
<li class=''><a href='/general/statistics/'>Application Statistics</a></li>
</ul>
  <h2><a href="/client-lib-development-guide/">Library Development</a></h2>
<ul>
<li class=''><a href='/client-lib-development-guide/features/'>Features spec v0.8</a></li>
<li class=''><a href='/client-lib-development-guide/feature-prioritisation/'>Feature prioritisation</a></li>
<li class=''><a href='/client-lib-development-guide/protocol/'>Realtime Protocol Definition</a></li>
<li class=''><a href='/client-lib-development-guide/rest-api/'>REST API Definition</a></li>
<li class=''><a href='/client-lib-development-guide/test-api/'>Sandbox Test API</a></li>
<li class='selected'><a href='/client-lib-development-guide/encryption/'>Encryption</a></li>
<li class=''><a href='/client-lib-development-guide/websocket/'>WebSocket Transport</a></li>
<li class=''><a href='/client-lib-development-guide/comet/'>Comet Transport</a></li>
<li class=''><a href='/client-lib-development-guide/connection-recovery/'>Connection Recovery</a></li>
<li class=''><a href='/client-lib-development-guide/connection-manager/'>Connection Manager</a></li>
<li class=''><a href='/client-lib-development-guide/connection-fallback/'>Connection host fallback</a></li>
<li class=''><a href='/client-lib-development-guide/documentation-formatting-guide/'>Documentation Formatting Guide</a></li>
<li class=''><a href='/code-index/'>Code Examples List</a></li>
</ul>
  <ul>
<li><a href="https://www.ably.io">Visit Ably.io</a></li>
</ul>
</div>

</body>
</html>
